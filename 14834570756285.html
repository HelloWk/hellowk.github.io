<!doctype html>
<html class="no-js" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
     制作一个用 Siri 控制的 WiFi 灯 - WILL KEEP ... 
  </title>
   
  <link href="atom.xml" rel="alternate" title="WILL KEEP ..." type="application/atom+xml">
  <link rel="stylesheet" href="asset/css/bootstrap.css">
  <link href="asset/css/themify-icons.css" rel="stylesheet" type="text/css" media="all">
  <link rel="stylesheet" href="asset/css/foundation.min.css" />
  <link rel="stylesheet" href="asset/css/docs.css" />
  <script src="asset/js/vendor/modernizr.js"></script>
  <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/js/parallax/parallax.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <script src="asset/js/typing.min.js"></script>
  <script src="asset/js/scripts.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="asset/css/theme.css">
  <link rel="stylesheet" href="asset/css/custom.css">
  <link rel="stylesheet" href="asset/css/typing.css">
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  <script type="text/javascript">
    function before_search() {
      var searchVal = 'site:hellowk.cc ' + document.getElementById('search_input').value;
      document.getElementById('search_q').value = searchVal;
      return true;
    }
  </script>
</head>

<body class="antialiased hide-extras">
  <div class="marketing off-canvas-wrap" data-offcanvas>
    <div class="inner-wrap">
      <nav class="top-bar docs-bar hide-for-small" data-topbar>
        <div class="top-bar-section">
          <div class="row">
            <div style="position: relative;width:100%;">
              <div style="position: absolute; width:100%;">
                <ul class="left">
                  <img src="asset/img/logo.png" style="height: 40px;">
                </ul>
                <ul id="main-menu" class="right">
                  
                  <li id=""><a target="_self" href="index.html">Home</a></li>
                  
                  <li id=""><a target="_self" href="archives.html">Archives</a></li>
                  
                  <li id=""><a target="_self" href="about.html">About</a></li>
                  
                </ul>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <nav class="tab-bar show-for-small">
        <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
          <span> &nbsp; WILL KEEP ...</span>
        </a>
      </nav>

      <aside class="left-off-canvas-menu">
        <ul class="off-canvas-list">
          <li><a href="index.html">HOME</a></li>
          <li><a href="archives.html">Archives</a></li>
          <li><a href="about.html">ABOUT</a></li>
          <li><label>Categories</label></li>

          
          <li><a href="raspberry-pi.html">RASPBERRY PI</a></li>
          
          <li><a href="NANO%20PI.html">NANO PI</a></li>
          
          <li><a href="HOME%20AUTOMATION.html">HOME AUTOMATION</a></li>
          
          <li><a href="APP.html">APP</a></li>
          

        </ul>
      </aside>
      <a class="exit-off-canvas" href="#"></a>
      <div id="main-content" role="main" class="scroll-container"> <script type="text/javascript">
  $(function() {
    $('#menu_item_index').addClass('is_active');
  });
</script>
<div class="bigtitle">
  <div class="row">
    <div class="col-sm-12 mb0">
        <h2 class="uppercase mb8">制作一个用 Siri 控制的 WiFi 灯</h2>
        <div class="read-more clearfix">

          <ul class="post-meta">
            <li>
              <i class="ti-calendar"></i>
              <span class="date">3/13/2016 21:0 下午</span>
            </li>
            <li>
              
              <i class="ti-tag"></i>
              <span>posted in&nbsp;</span>  
              <span class="posted-in"><a href='HOME%20AUTOMATION.html'>HOME AUTOMATION</a></span> 
              <span class="posted-in"><a href='raspberry-pi.html'>RASPBERRY PI</a></span> 
              <span class="posted-in"><a href='NANO%20PI.html'>NANO PI</a></span> 
            </li>
            <li>
              <span class="comments">
             
             
           </span>
            </li>
          </ul>
        </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="large-8 medium-8 columns">
    <div class="markdown-body article-wrap">
      <div class="article">
        
      </div>
      <!-- article -->

      <div class="article-content">
        <hr/>

<p>偶然间在 <a href="http://www.makeuseof.com/service/diy-projects/">make use of</a> 发现一篇文章 <a href="http://www.makeuseof.com/tag/make-diy-siri-controlled-wi-fi-light/" title="How to Make a DIY Siri-Controlled Wi-Fi Light">How to Make a DIY Siri-Controlled Wi-Fi Light</a>，使用 Siri 控制一个可以连接 WiFi 的灯，哦。。。。不对，等会，，，什么东西控制？？</p>

<p><strong>Siri？</strong></p>

<p>仔细看看，果然是 Siri，费劲阅读下来，果然是篇好文章，充分吊起了我 DIY 的念头，正好手里有一部分需要的东西，然后去某宝凑齐其他的东西，开始自己做一个。</p>

<p><img src="http://7xr14u.com1.z0.glb.clouddn.com/siricontrolledwifilight/siri_controlled_wifi_light_1.png" alt=""/></p>

<span id="more"></span><!-- more -->

<p>这个使用 Siri 控制的灯除了一个能运行 Siri 的设备外，还需要一些其他的东西：</p>

<ul>
<li>一个可以运行 Linux 的服务器，这里选择使用过完年刚入手的 NanoPi2，正好空闲。NanoPi自带 WiFi，用着更方便，我的树莓派被用在制作魔镜上面了，用树莓派也是一样的，树莓派推荐 Raspberry Pi 2 model B 树莓派使用网线连接也可以（最新出的 RPi3 有 WiFi 哦）。</li>
<li>一个 ESP8266 的 NodeMCU 模块，有 WiFi，还有个小型的处理器可以直接运行代码，WiFi 灯就用这个控制。</li>
<li>一个 WS2812 的 LED 灯带，这个灯带的光源采用 SMD 5050 LED，自带控制芯片，具有以下好处，做个环境灯还是不错的：

<ul>
<li>每个像素点的三基色颜色可实现256级亮度显示，完成16777216种颜色的全真色彩显示。</li>
<li>串行级联接口，能通过一根信号线完成数据的接收与解码。</li>
<li>任意两点传传输距离在不超过5米时无需增加任何电路。</li>
</ul></li>
</ul>

<p>我这里只是使用了一个 16 灯的灯环来做实验，跟灯带是一样的，只是个数不同。</p>

<p><img src="http://7xr14u.com1.z0.glb.clouddn.com/siricontrolledwifilight/siri_controlled_wifi_light_2.png" alt=""/></p>

<h2 id="toc_0">搭建一个给 Siri 提供服务的服务器</h2>

<p>用 Siri 控制电灯可不是你跟她说两句话就可以的，至少目前不行，她不知道你到底要干什么；但是有了服务器后你只需跟她动动嘴她就知道要干什么了。</p>

<h3 id="toc_1">搭建 mqtt 服务器</h3>

<p>MQTT（Message Queuing Telemetry Transport，消息队列遥测传输）是IBM开发的一个即时通讯协议，有可能成为物联网的重要组成部分。该协议支持所有平台，几乎可以把所有联网物品和外部连接起来，被用来当做传感器和致动器（比如通过Twitter让房屋联网）的通信协议。</p>

<p>我们需要他作为消息的传输。</p>

<h4 id="toc_2">安装 git</h4>

<p>有些系统内没有带 git，需要自己安装：</p>

<pre><code class="language-no-highlight">sudo apt-get install git
</code></pre>

<h4 id="toc_3">安装 libwebsockets</h4>

<p>这里需要这个库做 <code>web sockets</code> 的支持：</p>

<pre><code class="language-no-highlight">sudo apt-get install cmake libssl-dev
cd &lt;SRC&gt;   # i.e. your source code home
sudo wget http://git.warmcat.com/cgi-bin/cgit/libwebsockets/snapshot/libwebsockets-1.6.0-chrome48-firefox42.tar.gz
sudo tar -xzvf libwebsockets-1.6.0-chrome48-firefox42.tar.gz
cd libwebsockets-1.6.0-chrome48-firefox42/
mkdir build
cd build
cmake .. -DOPENSSL_ROOT_DIR=/usr/bin/openssl
make
sudo make install
</code></pre>

<h4 id="toc_4">安装 Mosquitto</h4>

<p>Mosquitto 是一款实现了消息推送协议 MQTT v3.1 的开源消息代理软件，提供轻量级的，支持可发布/可订阅的的消息推送模式，使设备对设备之间的短消息通信变得简单，比如现在应用广泛的低功耗传感器，手机、嵌入式计算机、微型控制器等移动设备。一个典型的应用案例就是 Andy Stanford-Clark Mosquitto（MQTT协议创始人之一）在家中实现的远程监控和自动化。</p>

<p>这个安装比较复杂，但是只要有点耐心，还是很容易的。</p>

<pre><code class="language-no-highlight">cd &lt;SRC&gt;   # i.e. your source code home 你放源代码的地方
sudo wget http://mosquitto.org/files/source/mosquitto-1.4.8.tar.gz
sudo tar xvf mosquitto-1.4.8.tar.gz
cd mosquitto-1.4.8/
</code></pre>

<p>首先需要编辑 <code>config.mk</code> 打开 <code>websockets</code> 为 <code>yes</code>：</p>

<pre><code class="language-no-highlight">sudo vim config.mk
</code></pre>

<p>找到 <code>WITH_WEBSOCKETS</code>，修改为：</p>

<pre><code class="language-profile">WITH_WEBSOCKETS:=yes
</code></pre>

<p>然后安装 <code> pre-reqs:-</code> （支持文件？）</p>

<pre><code class="language-no-highlight">sudo apt-get install uuid-dev xsltproc docbook-xsl
</code></pre>

<p>最后：</p>

<pre><code class="language-no-highlight">make
make test
sudo make install
</code></pre>

<p>如果你遇到关于缺失 <code>ares.h</code> 的错误：</p>

<pre><code class="language-no-highlight">cd &lt;SRC&gt;   # i.e. your source code home
wget http://c-ares.haxx.se/download/c-ares-1.10.0.tar.gz
tar xvf c-ares-1.10.0.tar.gz
cd c-ares-1.10.0
./configure
make
sudo make install
</code></pre>

<blockquote>
<p>如果你 <code>make test</code> 遇到了错误，估计是 websockets 在共享库的目录中没有放库文件，试试这么做：</p>

<pre><code class="language-no-highlight">cd &lt;SRC&gt;/org.eclipse.mosquitto/test/broker
../../src/mosquitto -p 1888
</code></pre>

<p>如果是共享库的问题，你可以马上看到他，像这样做一些事儿：</p>

<pre><code class="language-no-highlight">find /usr -name libwebsockets.so.6
</code></pre>

<p>我的是：</p>

<pre><code class="language-no-highlight">/usr/local/lib/libwebsockets.so.6
</code></pre>

<p>然后：</p>

<pre><code class="language-no-highlight">sudo vi /etc/ld.so.conf.d/libc.conf
</code></pre>

<p>在最后添加：</p>

<pre><code class="language-profile">\#lib64c default configuration
/usr/local/lib64
</code></pre>

<p>然后：</p>

<pre><code class="language-no-highlight">sudo ldconfig
</code></pre>

<p>重试 <code>make test</code>。</p>
</blockquote>

<p><code>make test</code> 没问题后：</p>

<pre><code class="language-no-highlight">sudo make install
</code></pre>

<p>复制配置文件和建立一个 <code>Service User ID</code> 。</p>

<pre><code class="language-no-highlight">sudo cp mosquitto.conf /etc/mosquitto
sudo useradd -r -m -d /var/lib/mosquitto -s /usr/sbin/nologin -g nogroup mosquitto
</code></pre>

<p><strong> 3.10.2016 Update：编辑配置文件</strong>
编辑 conf 文件：</p>

<pre><code class="language-no-highlight">sudo vim /etc/mosquitto/mosquitto.conf
</code></pre>

<p>然后在最下面写入：</p>

<pre><code class="language-profile">port 1883
listener 9001
protocol websockets
</code></pre>

<p>这个配置是使用 ‘9001’ 作为 websockets 的监听端口，这样通过 web 的链接就走 ‘9001’ 这个端口，而 client 通过 ’1883‘ 这个端口来通信，这也是默认 client 的端口。</p>

<p>启动服务：</p>

<pre><code class="language-no-highlight">sudo /usr/local/sbin/mosquitto -c /etc/mosquitto/mosquitto.conf
</code></pre>

<h4 id="toc_5">开机自启动</h4>

<p>如果你重启一下会发现 mosquitto 服务没有开机运行，每次手动运行会很麻烦，所以我们创建一个启动服务让他开机运行。</p>

<p>新建一个启动服务文件：</p>

<pre><code class="language-no-highlight">sudo vim  /etc/init.d/mosquitto
</code></pre>

<p>输入一下内容：</p>

<pre><code class="language-profile">#!/bin/bash
# /etc/init.d/mosquitto

### BEGIN INIT INFO
# Provides:          mosquitto
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start mosquitto at boot time
# Description:       Enable service provided by daemon.
### END INIT INFO

case &quot;$1&quot; in 
    start)
        echo &quot;Starting Mosquitto Server&quot;
        /usr/local/sbin/mosquitto -c /etc/mosquitto/mosquitto.conf &lt; /dev/null &amp;
        ;;
    stop)
        echo &quot;Stopping Mosquitto Server&quot;
        killall mosquitto
        ;;
    *)
        echo &quot;Usage: /etc/init.d/mosquitto start|stop&quot;
        exit 1
        ;;
esac

exit 0
</code></pre>

<p>然后进行以下操作让服务开机运行：</p>

<pre><code class="language-no-highlight">sudo chown root:root /etc/init.d/mosquitto
sudo chmod +x /etc/init.d/mosquitto
sudo update-rc.d mosquitto defaults
sudo update-rc.d mosquitto enable
</code></pre>

<p>重启试试看，可以使用 MQTT.fx 这个软件进行测试。</p>

<h3 id="toc_6">安装 Homekit 服务器</h3>

<p>HomeKit，是苹果2014年发布的智能家居平台。这才是我们使用 Siri 控制电灯的关键。</p>

<h4 id="toc_7">安装 Node.js</h4>

<p>我们一会要安装 <code>HAP-NodeJS</code> 这个开源的 HomeKit 服务器，但是他需要 <code>Node.js</code> 的支持：</p>

<pre><code class="language-no-highlight">sudo wget https://nodejs.org/dist/v5.8.0/node-v5.8.0-linux-armv7l.tar.xz
sudo tar xvf node-v5.8.0-linux-armv7l.tar.xz 
</code></pre>

<p>解压后，在 <code>bin</code> 文件夹中已经存在 <code>node</code> 以及 <code>npm</code>，如果你进入到对应文件的中执行命令行一点问题都没有，不过不是全局的，所以将这个设置为全局就好了：</p>

<pre><code class="language-no-highlight">sudo ln -s /source-code-home/node-v5.8.0-linux-armv7l/bin/node /usr/local/bin/node
udo ln -s /source-code-home/node-v5.8.0-linux-armv7l/bin/npm /usr/local/bin/npm
</code></pre>

<p>这里 <code>/source-code-home/</code> 就是你放 <code>Node.js</code> 的地方，改成自己的就好。</p>

<p>接下来，我们安装一些 <code>Node</code> 的模块：</p>

<pre><code class="language-no-highlight">sudo npm install -g npm
sudo npm install -g node-gyp
</code></pre>

<p>实际上，第一条代码是使用 Node Package Manager (npm) 安装一个最新的版本。这一步我卡了一晚上也没有过去，直接略过。</p>

<p>第二条命令如果有错误请试试：</p>

<pre><code class="language-no-highlight">sudo npm cache clean
</code></pre>

<h4 id="toc_8">HAP-NodeJS:</h4>

<p><a href="https://github.com/KhaosT/HAP-NodeJS">HAP-NodeJS</a> 是使用 <code>Node.js</code> 实现的 HomeKit 服务器，这是 HomeKit 请求和 WiFi 设备之间的桥梁。</p>

<p>安装 HAP 很简单：</p>

<pre><code class="language-no-highlight">git clone https://github.com/KhaosT/HAP-NodeJS.git
cd HAP-NodeJS
npm rebuild
sudo npm install node-persist
sudo npm install srp
</code></pre>

<p>在安装 <code>srp</code> 时如果出现 <code>#error This version of node/NAN/v8 requires a C++11 compiler</code>：</p>

<pre><code class="language-no-highlight">sudo apt-get install gcc-4.8 g++-4.8
sudo update-alternatives --install/usr/bin/gccgcc/usr/bin/gcc-4.6 20
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.8 50
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.6 20
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.8 50
</code></pre>

<p>然后继续：</p>

<pre><code class="language-no-highlight">sudo npm install srp
sudo npm install mdns --unsafe-perm
</code></pre>

<p>安装 <code>mdns</code> 时如果出现 <code>error: dns_sd.h: No such file or directory </code>：</p>

<pre><code class="language-no-highlight">sudo apt-get install libavahi-compat-libdnssd-dev
</code></pre>

<p>继续：</p>

<pre><code class="language-no-highlight">sudo npm install mdns --unsafe-perm
sudo npm install debug
sudo npm install ed25519 --unsafe-perm
sudo npm install curve25519 --unsafe-perm
</code></pre>

<p>这样 HAP 就全部弄好了，你可以通过以下命令去运行：</p>

<pre><code class="language-no-highlight">sudo node Core.js
</code></pre>

<p><img src="http://7xr14u.com1.z0.glb.clouddn.com/siricontrolledwifilight/siri_controlled_wifi_light_3.png" alt=""/></p>

<p>你立刻就能看到已经创建了 6 个虚拟的设备。我们使用这些作为我们 WiFi 灯的开始，但是我们要先使用这些开始测试一下。</p>

<p>现在你需要一个可以使用 Siri 的 Apple 设备；苹果并没有提供一个关于 Homekit 的 App，所以我们可以下载一个免费的软件：<a href="https://itunes.apple.com/us/app/elgato-eve/id917695792?mt=8" title="Elgato Eve app">Elgato Eve app</a>，一个一个可以让你添加自己的设备（即使不是 Elgato 的设备）到 Homekit 网络并管理的 App。</p>

<p>第一次打开软件他会让你命名你的家，填好后进行下一步，这里我们选择<code>添加附件</code>，然后选择一个设备，比如 <code>light</code>。</p>

<p><img src="http://7xr14u.com1.z0.glb.clouddn.com/siricontrolledwifilight/siri_controlled_wifi_light_4.png" alt=""/></p>

<p>然后他会公诉你需要唯一的设置代码才能安全的添加到家庭，不管他，选择<strong>添加到「你家的名字」</strong>。</p>

<p>然后他会告诉你此配件没有认证，仍然添加，然后他会与此配件配对。</p>

<p><img src="http://7xr14u.com1.z0.glb.clouddn.com/siricontrolledwifilight/siri_controlled_wifi_light_5.png" alt=""/></p>

<p>选手动输入代码，然后输入以下的数字：</p>

<pre><code class="language-no-highlight">031-45-154
</code></pre>

<p>这个代码可以在 <code>Light_accessory.js</code> 文件中找到并修改。</p>

<p>添加这个配件到你的默认房间，给他起个名字，然后选择一个图标。</p>

<p>然后你回到你运行 HAP-NodeJS 的命令行那里，你会发现会有消息“Are we on?”出现，这是软件在查看此配件的信息。然后打开 Siri 告诉她：“把（你给灯起的名字）打开”，然后在关闭它。然后你会在命令行内发现如下信息：</p>

<pre><code class="language-text">Are we on? No.
Turning the light on!
Turning the light off!
</code></pre>

<p>非常棒，到这里我们就完成了服务的搭建，你也可以使用 Siri 控制一个虚拟的灯，接下来我们就实际制作一个真的 WiFi 灯。</p>

<h2 id="toc_9">制作一个真的 WiFi 灯</h2>

<p>在这里这个硬件我们使用 NodeMCU 开发板去控制 WS2812 的灯带，你会发现惊人的简单，我们能直接使用 NodeMCU 开发板驱动灯带然后使用 USB 去链接（当然如果灯带过长还是建议你用的单独的电源去驱动灯带然后使用 NodeMCU 开发板来控制它）。如果你没有这个灯带的话，你也可以使用一个继电器去控制电灯的电源，或者你能使用的方式去控制它，不过，注意安全。</p>

<p>把灯带的电源线连在开发板的 VIN Pin，地线连在 GND Pin，把信号线接在 NodeMCU 上标有 D2 字样的针脚上（或者你自己喜欢的那个，当然程序中也要对应修改）。</p>

<p>如果你还没有搭建使用 Arduino 编译 NodeMCU 的环境，你可以先去 <a href="http://www.makeuseof.com/tag/meet-arduino-killer-esp8266/" title="ESP8266: Arduino Killer">ESP8266: Arduino Killer</a> 这篇文章搭建好环境并能工作后再回来继续我们的制作。你需要安装一下这些库：</p>

<p><a href="https://github.com/adafruit/Adafruit_NeoPixel" title="Adafruit’s NeoPixels">Adafruit’s NeoPixels</a>
<a href="https://github.com/256dpi/arduino-mqtt">Arduino-MQTT</a></p>

<p>然后你可以把下面的代码 Update 到你的 NodeMCU 中：</p>

<pre><code class="language-C">#include &lt;ESP8266WiFi.h&gt;
#include &lt;MQTTClient.h&gt;
#include &lt;Adafruit_NeoPixel.h&gt;

#define PIN 4

// Parameter 1 = number of pixels in strip
// Parameter 2 = Arduino pin number (most are valid)
// Parameter 3 = pixel type flags, add together as needed:
//   NEO_KHZ800  800 KHz bitstream (most NeoPixel products w/WS2812 LEDs)
//   NEO_KHZ400  400 KHz (classic &#39;v1&#39; (not v2) FLORA pixels, WS2811 drivers)
//   NEO_GRB     Pixels are wired for GRB bitstream (most NeoPixel products)
//   NEO_RGB     Pixels are wired for RGB bitstream (v1 FLORA pixels, not v2)
Adafruit_NeoPixel strip = Adafruit_NeoPixel(16, PIN, NEO_GRB + NEO_KHZ800);

const char* ssid = &quot;your wifi ssid&quot;;
const char* password = &quot;your wifi password&quot;;
const char* host = &quot;homekit/officelight&quot;; // the name of your fixture, and the base channel to listen to
const char* server = &quot;192.168.31.206&quot;; // your MQTT server host
String clientName = &quot;officelight&quot;;


/**************************************************************/
/* NO NEED TO CHANGE BENEATH THIS LINE */

int hue = 0;
float brightness = 0.0;
float saturation = 0.0;

#define BUFFER_SIZE 100

WiFiClient wifiClient;
MQTTClient client;

void setup() {
  Serial.begin(115200);
  client.begin(server,wifiClient);
  Serial.println(&quot;Booting&quot;);

//  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(&quot;.&quot;);
  }
  Serial.println(&quot;&quot;);

  Serial.println(&quot;Ready&quot;);
  Serial.print(&quot;IP address: &quot;);
  Serial.println(WiFi.localIP());

  strip.begin();
  strip.show(); // Initialize all pixels to &#39;off&#39;

}

void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    if (!client.connected()) {
      if (client.connect((char*) clientName.c_str())) {
        client.publish(&quot;outTopic&quot;,(String)&quot;hello world, I&#39;m &quot;+host);
        client.subscribe(host+(String)&quot;/#&quot;);
      }
    }

    if (client.connected())
      client.loop();
  }
}

// Convert Hue/Saturation/Brightness values to a packed 32-bit RBG color.
// hue must be a float value between 0 and 360
// saturation must be a float value between 0 and 1
// brightness must be a float value between 0 and 1
uint32_t HSVColor(float h, float s, float v) {

  h = constrain(h, 0, 360);
  s = constrain(s, 0, 1);
  v = constrain(v, 0, 1);

  int i, b, p, q, t;
  float f;

  h /= 60.0;  // sector 0 to 5
  i = floor( h );
  f = h - i;  // factorial part of h

  b = v * 255;
  p = v * ( 1 - s ) * 255;
  q = v * ( 1 - s * f ) * 255;
  t = v * ( 1 - s * ( 1 - f ) ) * 255;

  switch( i ) {
    case 0:
      return strip.Color(b, t, p);
    case 1:
      return strip.Color(q, b, p);
    case 2:
      return strip.Color(p, b, t);
    case 3:
      return strip.Color(p, q, b);
    case 4:
      return strip.Color(t, p, b);
    default:
      return strip.Color(b, p, q);
  }
}

void currentValues(){
  Serial.println(&quot;&quot;);
  Serial.println(&quot;Current State&quot;);
  Serial.print(&quot;Hue (0-360):&quot;);
  Serial.println(hue);
  Serial.print(&quot;Saturation (0-100 in, 0-1):&quot;);
  Serial.println(saturation*100);
  Serial.print(&quot;Brightness (0-100):&quot;);
  Serial.println(brightness*100);
  Serial.println(&quot;&quot;);
}

void messageReceived(String topic, String payload, char * bytes, unsigned int lgth) {
  uint16_t i, j;

  currentValues();
  String myMessage = String(payload);
  // handle message arrived
  Serial.print(topic);
  Serial.print(&quot; =&gt; &quot;);
  String myTopic = String(topic);

  if (topic == host) {
    Serial.println(payload);

    if(payload== &quot;on&quot;){
      brightness = 1.0;

      for (i = 0; i &lt; strip.numPixels(); i ++) {
        strip.setPixelColor(i, HSVColor(hue,saturation,brightness));
      }
      strip.show();
    } else {
      brightness = 0.0;

      for(i = 0; i &lt; strip.numPixels(); i ++) {
        strip.setPixelColor(i, HSVColor(hue,saturation,brightness));
      }
      strip.show();
    }

  } else if (topic == host + (String)&quot;/brightness&quot;) { 
    // Brightness up to 100
    Serial.println(payload);
    brightness = (payload.toFloat()) / 100;
    for (i = 0; i &lt; strip.numPixels(); i ++) {
      strip.setPixelColor(i, HSVColor(hue,saturation,brightness));
    }
    strip.show();

  } else if (topic == host + (String)&quot;/hue&quot;) { 
    // Hue value 0-360
    Serial.println(payload);
    hue = payload.toInt();
    for (i = 0; i &lt; strip.numPixels(); i ++) {
      strip.setPixelColor(i, HSVColor(hue,saturation,brightness));
    }
    strip.show();

  } else if (topic == host + (String)&quot;/saturation&quot;) { 
    // Saturation value at 0-100
    Serial.println(payload);
    saturation = (payload.toFloat()) / 100;
    for (i = 0; i &lt; strip.numPixels(); i ++) {
      strip.setPixelColor(i, HSVColor(hue,saturation,brightness));
    }
    strip.show();

  }
  currentValues();
}
</code></pre>

<p>你需要把这些改成你自己的网络设置：</p>

<pre><code class="language-C">const char* ssid = &quot;your wifi ssid&quot;;
const char* password = &quot;your wifi password&quot;;
const char* host = &quot;homekit/officelight&quot;;
const char* server = &quot;192.168.31.206&quot;;
</code></pre>

<p>这里只使用了16颗 LED 的小灯组，你可以添加更多的灯并控制它。上传完成后你就可以打开你最喜欢的 MQTT 客户端测试一下了：</p>

<ul>
<li>你可以发送 <code>on</code> 到 <code>homekit/officelight</code> 打开灯带，发送 <code>off</code> 关闭它。</li>
<li>你能发送数字 0 - 360 到 <code>homekit/officelight/hue</code> 来改变颜色。这里使用的是 <a href="https://en.wikipedia.org/wiki/HSL_and_HSV" title="HSV color space">HSV color space</a>，所以 0 和 360 是红，120 是绿，240 是蓝。</li>
<li>你能发送 0 - 100 到 <code>homekit/officelight/brightness</code> 来改变灯的亮度，也就是 0% - 100% 的亮度值。</li>
<li>同理可以发送到 <code>homekit/officelight/saturation</code> 改变饱和度，最大是 100。</li>
</ul>

<p>测试完成后你就可以把灯带固定到你想要放的地方了。然后回来我们继续，让 Siri 能够控制他。</p>

<p><img src="http://7xr14u.com1.z0.glb.clouddn.com/siricontrolledwifilight/siri_controlled_wifi_light_6.png" alt=""/></p>

<h2 id="toc_10">设定一个 HomeKit 的附件</h2>

<p>回到我们的 HAP-NodeJS 服务器的目录下，定位到 <code>/accessories</code> 文件夹下面，你可以直接使用以下命令下载一个已经配置好的附件文件到你的目录中：</p>

<pre><code class="language-no-highlight">wget https://gist.githubusercontent.com/jamesabruce/a6607fa9d93e41042fee/raw/12e4fd1d1c2624e7540ba5e17c3e79bc6bdec5fd/Officelight_accessory.js
</code></pre>

<p>或者复制下面的代码新建一个名称格式为 <code>[you accessories name]_accessory.js</code> 的文件：</p>

<pre><code class="language-javascript">//MQTT Setup
var mqtt = require(&#39;mqtt&#39;);
console.log(&quot;Connecting to MQTT broker...&quot;);
var mqtt = require(&#39;mqtt&#39;);
var options = {
  port: 1883,
  host: &#39;localhost&#39;,
  clientId: &#39;HelloWk Wifi Light&#39;
};
var client = mqtt.connect(options);
console.log(&quot;Wifi Light Connected to MQTT broker&quot;);


var Accessory = require(&#39;../&#39;).Accessory;
var Service = require(&#39;../&#39;).Service;
var Characteristic = require(&#39;../&#39;).Characteristic;
var uuid = require(&#39;../&#39;).uuid;

//here&#39;s a fake hardware device that we&#39;ll expose to HomeKit
var OFFICELIGHT = {
  powerOn: false,
  brightness: 100, // percentage
  hue: 0,
  saturation: 0,

  setPowerOn: function(on) { 
    console.log(&quot;Turning Office Light %s!&quot;, on ? &quot;on&quot; : &quot;off&quot;);

    if (on) {
      client.publish(&#39;homekit/officelight&#39;, &#39;on&#39;);
      OFFICELIGHT.powerOn = on;
    } 
    else {
      client.publish(&#39;homekit/officelight&#39;,&#39;off&#39;);
      OFFICELIGHT.powerOn = false;   
   };

  },
  setBrightness: function(brightness) {
    console.log(&quot;Setting light brightness to %s&quot;, brightness);
    client.publish(&#39;homekit/officelight/brightness&#39;,String(brightness));
    OFFICELIGHT.brightness = brightness;
  },
  setHue: function(hue){
    console.log(&quot;Setting light Hue to %s&quot;, hue);
    client.publish(&#39;homekit/officelight/hue&#39;,String(hue));
    OFFICELIGHT.hue = hue;
  },
  setSaturation: function(saturation){
    console.log(&quot;Setting light Saturation to %s&quot;, saturation);
    client.publish(&#39;homekit/officelight/saturation&#39;,String(saturation));
    OFFICELIGHT.saturation = saturation;
  },
  identify: function() {
    console.log(&quot;Identify the light!&quot;);
  }
}

// Generate a consistent UUID for our light Accessory that will remain the same even when
// restarting our server. We use the `uuid.generate` helper function to create a deterministic
// UUID based on an arbitrary &quot;namespace&quot; and the word &quot;OFFICELIGHT&quot;.
var lightUUID = uuid.generate(&#39;hap-nodejs:accessories:OFFICELIGHT&#39;);
    
// This is the Accessory that we&#39;ll return to HAP-NodeJS that represents our fake light.
var light = exports.accessory = new Accessory(&#39;Office Light&#39;, lightUUID);
    
// Add properties for publishing (in case we&#39;re using Core.js and not BridgedCore.js)
light.username = &quot;FF:FF:FF:FF:CC:1A&quot;;
light.pincode = &quot;031-45-154&quot;;
    
// set some basic properties (these values are arbitrary and setting them is optional)
light
  .getService(Service.AccessoryInformation)
  .setCharacteristic(Characteristic.Manufacturer, &quot;MakeUseOf&quot;)
  .setCharacteristic(Characteristic.Model, &quot;Rev-1&quot;)
  .setCharacteristic(Characteristic.SerialNumber, &quot;LOLWUT&quot;);

// listen for the &quot;identify&quot; event for this Accessory
light.on(&#39;identify&#39;, function(paired, callback) {
  OFFICELIGHT.identify();
  callback(); // success
});

// Add the actual Lightbulb Service and listen for change events from iOS.
// We can see the complete list of Services and Characteristics in `lib/gen/HomeKitTypes.js`
light
    .addService(Service.Lightbulb, &quot;Office Light&quot;) // services exposed to the user should have &quot;names&quot; like &quot;Fake Light&quot; for us
    .getCharacteristic(Characteristic.On)
    .on(&#39;set&#39;, function(value, callback) {
       OFFICELIGHT.setPowerOn(value);
       callback(); // Our fake Light is synchronous - this value has been successfully set
    });
    
// We want to intercept requests for our current power state so we can query the hardware itself instead of
// allowing HAP-NodeJS to return the cached Characteristic.value.
light
    .getService(Service.Lightbulb)
    .getCharacteristic(Characteristic.On)
    .on(&#39;get&#39;, function(callback) {
    
      // this event is emitted when you ask Siri directly whether your light is on or not. you might query
      // the light hardware itself to find this out, then call the callback. But if you take longer than a
      // few seconds to respond, Siri will give up.
    
     var err = null; // in case there were any problems
    
     if (OFFICELIGHT.powerOn) {
        console.log(&quot;Are we on? Yes.&quot;);
        callback(err, true);
     } else {
        console.log(&quot;Are we on? No.&quot;);
        callback(err, false);
      }
    });
    
// also add an &quot;optional&quot; Characteristic for Brightness
light
  .getService(Service.Lightbulb)
  .addCharacteristic(Characteristic.Brightness)
  .on(&#39;get&#39;, function(callback) {
    callback(null, OFFICELIGHT.brightness);
  })
  .on(&#39;set&#39;, function(value, callback) {
    OFFICELIGHT.setBrightness(value);
    callback();
  })

light
  .getService(Service.Lightbulb)
  .addCharacteristic(Characteristic.Hue)
  .on(&#39;get&#39;,function(callback){
   callback(null,OFFICELIGHT.hue);
   })
   .on(&#39;set&#39;,function(value,callback){
   OFFICELIGHT.setHue(value);
   callback();   
   })

light
  .getService(Service.Lightbulb)
  .addCharacteristic(Characteristic.Saturation)
  .on(&#39;get&#39;,function(callback){
   callback(null,OFFICELIGHT.saturation);
   })
   .on(&#39;set&#39;,function(value,callback){
   OFFICELIGHT.setSaturation(value);
   callback();   
   })
</code></pre>

<p>实际上，不管你是直接下载文件也好还是新建也好，本质都是复制默认的 <code>light accessory</code>，然后改成你自己的需要的名字，以下是你自己创建一个 <code>accessory</code> 时需要注意的地方：</p>

<ul>
<li>所有的 accessory 都要命名为 <strong><code>*_accessory.js</code></strong></li>
<li>添加你自己的 MQTT 服务在文件的最上方。</li>
<li>如果你想设置一个自己的设备名，搜索/替换 所有的 <code>officelight</code> 为你自己的唯一不变的设备名。</li>
<li>为你的设备分配一个唯一的 16 进制的标识（<code>light.username = “1B:2B:3C:5D:6E:FF”;</code>）。</li>
<li>不要更改 PIN 码，他有一个固定的格式，如果你随便改的话将不能成功配对。</li>
</ul>

<p>现在你把你的新设备加入 Elgato Eve app 来试试看吧。如果出现提示缺少 <code>mqtt</code> 时运行一下命令：</p>

<pre><code class="language-no-highlight">sudo npm install mqtt
</code></pre>

<p>然后再试一遍。</p>

<p>最后，我们把 HAP-NodeJS 加入开机自动运行，编辑 <code>etc/rc.local</code> 这个文件，把下面这行加在 <code>exit 0</code> 之前：</p>

<pre><code class="language-no-highlight">sudo node /home/pi/HAP-NodeJS/Core.js &lt; /dev/null &amp;
</code></pre>

<p>最后一个步骤：去定位到 <code>/accessories</code> 文件夹下，删除其他的虚拟设备，好了，你可以尽情体验 Siri 控制灯带了。</p>

<h2 id="toc_11">还有什么是 Siri 能够控制的？</h2>

<p>现在你已经会了最基本的控制，但是这里你能控制的东西没有极限——如果你能使用 <code>Javascript</code> 进行编程的话，你可以创建你自己的设备文件。这个项目有很多的潜力，只要你能想得到，相信你会玩的很愉快。</p>

<p>以上。</p>

<hr/>

<p>更多精彩内容：<a href="http://www.shumeipaiba.com">树莓派吧</a>，更多树莓派问题讨论：<a href="http://bbs.shumeipaiba.com/forum-41-1.html" title="树莓派吧论坛">树莓派吧论坛</a></p>




      </div>

      <div class="row">
        <div class="large-6 columns">
          <p class="text-left" style="padding:15px 0px;">
            
            <a href="14834588749279.html" title="Previous Post: iOS 10 Home App 简单体验">&laquo; iOS 10 Home App 简单体验</a> 
          </p>
        </div>
        <div class="large-6 columns">
          <p class="text-right" style="padding:15px 0px;">
            
            <a href="14834536550124.html" title="Next Post: 一个新玩具——NanoPi2">一个新玩具——NanoPi2 &raquo;</a> 
          </p>
        </div>
      </div>
      <div class="comments-wrap">
        <div class="share-comments">
            
        </div>
      </div>
    </div>
    <!-- article-wrap -->
  </div>
  <!-- large 8 --> <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
      <div id="site-info" class="site-info">
        
        <!--        <h1>WILL KEEP ...</h1>-->
<!--
        <h6 class="h-center">在平坦的路面上曲折前行</h2>
        <div class="site-des"></div>
        <div class="social">
          
          <a target="_blank" class="facebook" href="https://www.facebook.com/chenhsinwon" title="Facebook">Facebook</a>
           
           
           
          
           
           
           
          
          <a target="_blank" class="weibo" href="http://weibo.com/wkaiai" title="weibo">Weibo</a>
           
           
          
          <a target="_blank" class="github" target="_blank" href="https://github.com/HelloWk" title="GitHub">GitHub</a>
           
          
          <a target="_blank" class="email" href="mailto:katalynn00@gmail.com" title="Email">Email</a>
          
          <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
-->
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="raspberry-pi.html"><strong>RASPBERRY PI</strong></a>
        
            <a href="NANO%20PI.html"><strong>NANO PI</strong></a>
        
            <a href="HOME%20AUTOMATION.html"><strong>HOME AUTOMATION</strong></a>
        
            <a href="APP.html"><strong>APP</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="15087696019624.html">MQTTT - 好用又好看的MQTT工具 1.1.0 版</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15051827686802.html">使用 Siri 控制你的家 补充 - 功能更全的 Homebridge 米家接入插件</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="14902708868181.html">使用 Siri 控制你的家 3 - 开机自动运行 Homebridge</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="14902698259528.html">使用 Siri 控制你的家 2 - 接入米家的产品</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="14902608996424.html">使用 Siri 控制你的家 1 - 搭建服务器</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
              
<!--
              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>DOC</h2>
                </div>
                <div class="side-content">
                
                </div>
              </div>
-->
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row --> <div class="page-bottom clearfix footer-1 bg-dark">
  <div class="row">

    <div id="site-info" class="site-info">
      <h6 class="h-center">在平坦的路面上曲折前行</h6>
      <div class="social">
        
        <a target="_blank" class="facebook" href="https://www.facebook.com/chenhsinwon" title="Facebook">Facebook</a>
         
         
         
        
         
         
         
        
        <a target="_blank" class="weibo" href="http://weibo.com/wkaiai" title="weibo">Weibo</a>
         
         
        
        <a target="_blank" class="github" target="_blank" href="https://github.com/HelloWk" title="GitHub">GitHub</a>
         
        
        <a target="_blank" class="email" href="mailto:katalynn00@gmail.com" title="Email">Email</a>
        
        <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
      </div>
    </div>
    
    <p class="copyright">
      Copyright &copy; 2017 - <a target="_blank" href="about.html">ChenhsinWong</a><br>
    </p>
  </div>
  <a class="btn btn-sm fade-half back-to-top inner-link hidden-xs" href="#top">Top</a>
</div>
</section>
</div>
</div>

 

<script src="asset/js/foundation.min.js"></script>
<script>
  $(document).foundation();

  function fixSidebarHeight() {
    var w1 = $('.markdown-body').height();
    var w2 = $('#sidebar').height();
    if (w1 > w2) {
      $('#sidebar').height(w1);
    };
  }
  $(function() {
    fixSidebarHeight();
  })
  $(window).load(function() {
    fixSidebarHeight();
  });
</script>

<script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script> <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script> <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0a3e5a118e2f3e3553e02ecae4b2d2e3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

</body>

</html>